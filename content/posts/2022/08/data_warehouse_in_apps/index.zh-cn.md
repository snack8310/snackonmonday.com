---
title: "轻量级数据仓库产品开发"
date: 2022-08-15T17:24:04+08:00
draft: false
description: 在Saas/私有化部署的项目中需要构建一个数据仓库的产品，解决轻量级数据查询分析问题，记录产品的设计开发模式。
---

<!--more-->

## 背景
在Saas/私有化部署的项目开发过程中，有大量的数据报表需求。随着数据规模的增加，在业务层开发的数据报表就遇到了性能问题。

受限于产品要提供技术输出能力，降低成本的方式，不能引入公司的数据仓库产品，所以在应用层做了一个轻量级的数据仓库产品，用于解决问题。

## 数据仓库常见模式

常见的业务产品模式，通常是由业务前台系统+数据中台系统构建而成，数据通过离线定时同步或增量模式从前台系统到数据中台，数据分析人员通过中台的分析系统作业。比如Hadoop集群+bi分析工具的组合。

在当前产品上云的趋势下，云服务商大都提供了数据隔离的数据仓库解决方案。绝大部分企业内部场景，都可以直接使用，避免二次开发。

## 数据仓库的产品模块拆分
数据仓库产品通常包括三部分，数据提取，数据仓库构建，数据查询及输出。

我们也拆分为三个模块。

### 数据提取
数据提取负责把业务数据，或者第三方数据，进行数据清洗，转化成结构化的数据，用于保存到数据仓库中。

ETL（提取、转换和加载）是这个环节非常重要的一件事。

#### ETL方案

1. 使用开源工具，如Apache Nifi、Pentaho等
2. 企业自研。

#### ETL注意事项

1. 数据质量。
   
  由于数据的业务完整性是由业务系统保障的，在数据仓库构建时，需要考虑一些特定的清洗规则。比如一笔交易，第二天做了撤销。那么在业务数据中，是对第一条记录的更新，还是对第一条记录额外做红冲，就会影响数据清洗环节的处理。

2. 数据安全。

  敏感数据尽可能的加密或者同步中忽略掉。通常业务系统会有严格的用户数据权限，但数据仓库中的数据权限粒度，通常比较薄弱，造成超出权限的数据使用。

3. 可伸缩性。

  随着业务变化，数据量会大幅泽佳，ETL项目中要具备灵活调整。包括多个ETL项目的时间管理。

#### 实际问题
在数据拉取中，遇到的问题是数据语义的错误解析。

通常数据仓库的准确性问题都会在聚合报表中发现，后面会讲到数据降维，聚合层级较多，整个链路很长，语义解析错误往往到下游才会发现。

需要对ETL的数据做明确的数据匹配，提前通过业务人员，提供期望数据。测试驱动是个比较好的开发模式。

### 数据仓库构建
数据仓库的构建本质是使用空间换时间，通过结构化的存储，合并压缩数据，构建一个查询更有效率的业务模型宽表。

数据建模是数据仓库的核心。

好的架构模型，可以有利于管提升数据管理效率，及时释放一些无效数据。随着行业的发展，大家对于数据分层，聚合压缩也逐渐建立了一些共识。

常见的数据分层的方案，我们也是参照了行业内成熟的模式，进行了数据分层。

#### 数据分层

<div align=center>
	<img src="/img/2022/08/data/datahouse_layer.jpg"/>
</div>

上述内容是我们的数据仓库体系构建流程。

各层定义如下（内容参照AliCloud的文档）： 

1. ODS(Operational Data Store): 操作性数据存储
数据引入层，存放未经过处理的原始数据至数据仓库系统，作为数据库到数据仓库的一种过渡，ODS的数据结构一般与数据来源保持一致，便于减少ETL的工作复杂性，而且ODS的数据周期一般比较短。ODS的数据最终流入数据仓库。
ETL(Extract Transform and Load): 提取转换加载器，用来描述将数据从来源迁移到数据仓库的几个过程：

   - Extract，数据抽取，也就是把数据从数据源读出来。
   - Transform，数据转换，把原始数据转换成期望的格式和维度。如果用在数据仓库的场景下，Transform也包含数据清洗。
   - Load 数据加载，将处理后的数据加载。


1. CDM(Common Data Model): 通用数据模型层
包括DWD和DWS，由ODS层数据加工而成。主要完成数据加工与整合，建立一致性的维度，构建可复用的面向分析和统计的明细事实表，以及汇总公共粒度的指标。

   - DWD(Data Warehouse Detail): 数据仓库明细层
   - DWS(Data Warehouse Summary): 数据仓库汇总层


1. ADS(Application Data Service): 应用数据层
进行个性化指标加工，主要用于定制化、复杂性的指标，包含大部分复合指标。这些指标通常基于应用进行对CDM层数据进行组装。

各层次数据流走向如下图所示：
<div align=center>
	<img src="/img/2022/08/data/data_flow.jpg"/>
</div>

#### 数据分层目的

从数学上的理解，数据分层的目的是对数据降维。通过不同视角的数据归并，让数据集呈对数级的缩减。在最上游业务使用时，可以使用一个低维度的数据查询集。

<div align=center>
	<img src="/img/2022/08/data/data_demo.jpg"/>
</div>
这是我们设计的分层后的结构。可以看到越往上层，聚合的业务数据表越少。

当然会有很多定制的业务用数据集，但这些从数学期望上仍然是常量级的。而数据分层通常是指数/对数级的。

#### 数据分层优点

增强数据可用性。数据分层可以将数据划分为多个不同的层次，根据不同层次的数据处理目的和使用场景，提高数据可用性。

支持数据分析和决策。在数据分层的基础上，可以更方便地进行数据分析和决策。通过对不同层次的数据进行处理和整合，可以获得更全面、准确的数据。

简化数据管理和维护。数据分层可以将数据管理和维护划分为不同的层次，使得数据管理和维护更加简单，易于维护。

缺点

#### 数据分层缺点

增加了数据处理的复杂性。数据分层会使得数据处理过程更加复杂，需要进行不同层次数据的清洗、整合等处理操作，增加了数据处理的复杂性。

增加了数据仓库的设计难度。在设计数据仓库时，需要考虑不同数据层次的划分，需要对数据仓库进行更加细致的设计，增加了设计难度。

需要更多的存储空间。将数据分层会增加数据存储的空间，特别是对于多个层次的数据处理操作，可能需要更多的存储空间。

### 数据查询
数据仓库的上层应用可以用很多，比如直接提供数据系统的接入，提供建模后的数据表结构查询。

但数据表结构的底层工具实现有多重方案，比如行业常见的hadoop集群，也存在实现架构的不同，还有一些OLAP的数据库结构，也可以承载，甚至OLTP的数据库。

所以比较理想的方案，在数据查询的产品层面提供两个模型
1. 分析人员直接查询的平台工具，通过平台工具可以生成临时存储数据，建立在个人工作目录下。

<div align=center>
	<img src="/img/2022/08/data/data-analysis.png"/>
</div>

2. 提供一个标准的API数据，通过一个提供的数据字典，根据API的接口，提供分析类的查询功能。

这两部分仍然在进行中，待完成标准案例后更新。

## 下游产品应用
有了上述的基础，就可以构建基于数据仓库的产品。

这是我们的一个数据产品，定期提供数据报告，包括局部数据下载，通过邮件系统报告等发送给业务负责人。

<div align=center>
	<img src="/img/2022/08/data/app_demo.png"/>
</div>

当前的数据产品是直连的数据库（TiDB），这部分后面也会改成API的接口，可以提供规范化的参数标准，进一步降低应用的使用成本。

## 实时数据产品
实时统计类的数据产品，常见的模式有两个：

1. 准实时的方案。改进数据提取，缩短业务增量拉取间隔时间，缩短数据分层的生成时间。
2. 离线+在线方案。比如离线数据是T-1日，在线数据用当日数据T。应用层做数据汇总。

并不是我们这次实践的项目内容，本文就不展开了。

## 引用 

> [创建数据分层-阿里云](https://help.aliyun.com/document_detail/276023.html)